{% extends 'ClabCallCenterBundle:Default:base.html.twig' %}

{% block body %}
    <div class="container">
        {% include 'ClabCallCenterBundle:Default:breadcrumb.html.twig' with { step: 'client' } %}

        <br><br>
        <section class="panel">
            <div class="panel-body">
                <h2>1. Compte client</h2>

                <hr>
                <ul class="nav nav-tabs">
                    <li class="client active"><a data-toggle="tab" href="#client">Client existant</a></li>
                    <li class="newClient"><a data-toggle="tab" href="#newClient">Nouveau client</a></li>
                </ul>

                <div class="tab-content">
                    <div id="client" class="tab-pane fade in active">
                        <br>
                        <table class="table table-stripped table-bordered table-hover" id="datatable">
                            <thead>
                            <th>Email</th>
                            <th class="hidden-xs">Prénom</th>
                            <th>Nom</th>
                            <th>Sociéte</th>
                            <th class="hidden-xs">Téléphone</th>
                            <th>Actions</th>
                            </thead>
                            <tbody>
                            {% for user in users %}
                                <tr href="{{ path('clab_call_center_user_info',{userId : user.id}) }}">
                                    <td class="getInfos">
                                        {{ user.email }}
                                    </td>
                                    <td  class="hidden-xs getInfos">
                                        {{ user.firstName }}
                                    </td>
                                    <td class="getInfos">
                                        {{ user.lastName }}
                                    </td>
                                    <td>
                                        {% if user.company is not null %}
                                            {{ user.company.name }}
                                        {% endif %}
                                    </td>
                                    <td class="hidden-xs getInfos">
                                        {{ user.phone }}
                                    </td>
                                    <td>
                                        <a href="{{ path('clab_call_center_choose_customer',{id : user.id}) }}" data-toggle="tooltip" title="Commander">
                                            Commander <i class="fa fa-arrow-circle-right fa-2x" aria-hidden="true"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>

                        </table>
                        <ul class="list-inline">
                            {% if nbPages > 1 %}
                                {% for i in 0..3 %}
                                <li class="list-inline-item"><a class="btn btn-secondary {% if page == i %}active{% endif %}" href="{{ path('clab_call_center_homepage',{page: i }) }}">{{ i }}</a></li>
                                {% endfor %}
                                {% if page > 4 %}<li class="list-inline-item">...</li> {% endif %}
                                {% if page >= 3  and page <= (nbPages -4) %}
                                    {% if page > 4 %}
                                        <li class="list-inline-item"><a class="btn btn-secondary" href="{{ path('clab_call_center_homepage',{page: (page - 1) }) }}">{{ page - 1 }}</a></li>
                                    {% endif %}
                                    {% if page > 3 and  page < (nbPages -4) %}
                                        <li class="list-inline-item"><a class="btn btn-secondary active" href="{{ path('clab_call_center_homepage',{page: page }) }}">{{ page }}</a></li>
                                    {% endif %}
                                    {% if page < (nbPages -5) %}
                                        <li class="list-inline-item"><a class="btn btn-secondary" href="{{ path('clab_call_center_homepage',{page: (page + 1) }) }}">{{ page + 1 }}</a></li>
                                    {% endif %}
                                {% endif %}
                                {% if page <  (nbPages -5) %}<li class="list-inline-item">...</li>{% endif %}
                                {% for i in (nbPages-4)..(nbPages-1) %}
                                    <li class="list-inline-item"><a class="btn btn-secondary {% if page == i %}active{% endif %}" href="{{ path('clab_call_center_homepage',{page: i }) }}">{{ i }}</a></li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>
                    <div id="newClient" class="tab-pane fade">
                        <br>
                        <form action="{{ path('clab_call_center_homepage') }}" method="post" id="registerForm" {{ form_enctype(form) }}>
                            <div class="row">
                                <div class="form-group col-md-6">
                                    <div class="col-md-12">
                                        <label for="{{ form.phone.vars.id }}">Telephone *</label>
                                        {{ form_widget(form.phone, { 'attr': {'class': 'form-control phone-user'} }) }}

                                    </div>

                                        <div class="col-xs-12 col-md-6">
                                            <label for="{{ form.last_name.vars.id }}">Nom *</label>
                                            {{ form_widget(form.last_name, { 'attr': {'class': 'form-control'} }) }}
                                        </div>
                                        <div class="col-xs-12 col-md-6">
                                            <label for="{{ form.first_name.vars.id }}">Prénom *</label>
                                            {{ form_widget(form.first_name, { 'attr': {'class': 'form-control'} }) }}
                                        </div>

                                    <div class="col-md-12">
                                        <label for="{{ form.email.vars.id }}">Email</label>
                                        {{ form_widget(form.email, { 'attr': {'class': 'form-control email-user'} }) }}
                                    </div>
                                    <div class="col-md-12">
                                        <label for="email">Mot de passe</label>
                                        {{ form_widget(form.plainPassword, { 'attr': { 'class': 'form-control' } }) }}
                                    </div>

                                </div>
                                <div class="col-md-6">
                                    <div class="col-md-12">
                                        <label for="{{ form.is_male.vars.id }}">Sexe</label>
                                        {{ form_widget(form.is_male, { 'attr': {'class': 'form-control '} }) }}
                                    </div>
                                    <div class="col-xs-12">{{ form_label(form.birthday) }}</div>
                                    <div class="col-xs-12">
                                        <div class="col-xs-3" style="padding:0px">
                                            {{ form_widget(form.birthday.day, {'attr': {'class': 'form-control'}}) }}
                                        </div>
                                        <div class="col-xs-3" style="padding:0px">
                                            {{ form_widget(form.birthday.month, {'attr': {'class': 'form-control'}}) }}
                                        </div>
                                        <div class="col-xs-6" style="padding:0px">
                                            {{ form_widget(form.birthday.year, {'attr': {'class': 'form-control','value':'2000'}}) }}
                                        </div>
                                        {{ form_errors(form.birthday) }}
                                    </div>
                                    <div class="col-xs-12">
                                        <div class="col-xs-6 col-md-12" style="padding:0px">
                                            <label for="{{ form.homeAddress.street.vars.id }}">Adresse</label>
                                            {{ form_widget(form.homeAddress.street, { 'attr': {'class': 'form-control'} }) }}
                                        </div>
                                        <div class="col-xs-2 col-md-6" style="padding:0px">
                                            <label for="{{ form.homeAddress.zip.vars.id }}">Code postal</label>
                                            {{ form_widget(form.homeAddress.zip, { 'attr': {'class': 'form-control'} }) }}
                                        </div>
                                        <div class="col-xs-4 col-md-6" style="padding:0px">
                                            <label for="{{ form.homeAddress.city.vars.id }}">Ville</label>
                                            {{ form_widget(form.homeAddress.city, { 'attr': {'class': 'form-control'} }) }}
                                        </div>
                                    </div>
                                    <div class="col-xs-12">
                                        <div class="col-xs-6 no-padding">
                                            {{ form_row(form.company, {attr: { 'class': 'form-control'}}) }}
                                        </div>
                                        <div class="col-xs-6 no-padding">
                                            {{ form_row(form.business, {attr: { 'class': 'form-control'}}) }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-xs-12">
                                    <br>
                                    <p class="text-right"><button type="submit" class="btn btn-primary col-md-6 col-md-offset-3" id="buttonRegister">Valider</button></p>
                                </div>
                            </div>
                            {{ form_rest(form) }}
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </div>
{% endblock %}
{% block javascripts %}
    <script>
        // DataTable
        var table = $('#datatable').DataTable({
            responsive: true,
            "language": {
                "sProcessing":     "Traitement en cours...",
                "sSearch":         "Rechercher&nbsp;:",
                "sLengthMenu":     "Afficher _MENU_ &eacute;l&eacute;ments",
                "sInfo":           "Affichage de l'&eacute;l&eacute;ment _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",
                "sInfoEmpty":      "Affichage de l'&eacute;l&eacute;ment 0 &agrave; 0 sur 0 &eacute;l&eacute;ment",
                "sInfoFiltered":   "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
                "sInfoPostFix":    "",
                "sLoadingRecords": "Chargement en cours...",
                "sZeroRecords":    "Aucun &eacute;l&eacute;ment &agrave; afficher",
                "sEmptyTable":     "Aucune donn&eacute;e disponible dans le tableau",
                "oPaginate": {
                    "sFirst":      "Premier",
                    "sPrevious":   "Pr&eacute;c&eacute;dent",
                    "sNext":       "Suivant",
                    "sLast":       "Dernier"
                },
                "oAria": {
                    "sSortAscending":  ": activer pour trier la colonne par ordre croissant",
                    "sSortDescending": ": activer pour trier la colonne par ordre d&eacute;croissant"
                }
            }
        });

        var callUrl = "{{ apiDomain ~ "/api/v1/users/phone-search" }}";
        var tokenUrl = "{{ apiDomain ~ "/api/token" }}";
        var ttlDate = localStorage.getItem('ttlDate');
        var token = localStorage.getItem('token');
        var userFoundData = null;
        var regex = /^(0|\+33|33)[1-9]([-. ]?[0-9]{2}){4}$/;

        table.columns().every( function () {
            var that = this;

            $( 'input', this.header() ).on( 'keyup change', function () {
                if ( that.search() !== this.value ) {
                    that.search( this.value ).draw();
                }
            } );
        } );

        var timer = 0;
        var getCEUser = function() {
            clearTimeout (timer);
            var $self = $(this);
            let search = $self.val();
            timer = setTimeout(function(){
                $.get('{{ path('clab_call_center_search') }}'+'?search='+search, function(data){
                    table.clear();
                    var row;
                    var ul = "{{ path('clab_call_center_choose_customer',{id : 'USER'}) }}";
                    for(var k = 0;k<data.length;k++) {

                        row = [];
                        row.push(data[k]['email']);
                        row.push(data[k]['first_name']);
                        row.push(data[k]['name']);
                        row.push(data[k]['society']);
                        row.push(data[k]['phone']);
                        row.push('<a href="'+ul.replace('USER', data[k]['id'])+'" data-toggle="tooltip" title="Commander">'+
                                'Commander <i class="fa fa-arrow-circle-right fa-2x" aria-hidden="true"></i>'+
                                '</a>');
                        table.row.add(row);
                    }

                    table.draw()
                }).fail(function(){
                    sweetAlert('', "Aucun utilisateur trouvé", 'error');
                });
            }, 1000);
        };

        $('#datatable_filter').find('input[type="search"]').on('keyup',getCEUser);

        $('.user-found').on('click', function(){
            $('#client').removeClass("in active");
            $('#newClient').addClass("in active");
            $('.client').removeClass("active");
            $(".newClient").addClass("active");

            if (userFoundData.first_name){
                let firstNameId = "#{{ form.first_name.vars.id }}";
                $(firstNameId).val(userFoundData.first_name);
            }
            if (userFoundData.last_name){
                let lastNameId = "#{{ form.last_name.vars.id }}";
                $(lastNameId).val(userFoundData.last_name);
            }
            if (userFoundData.email){
                let emailId = "#{{ form.email.vars.id }}";
                $(emailId).val(userFoundData.email);
            }
            if (userFoundData.is_male){
                let isMaleId = "#{{ form.is_male.vars.id }}";
                $(isMaleId).val((userFoundData.is_male ? 1 : 0));
            }
            if (userFoundData.phone){
                let phoneId = "#{{ form.phone.vars.id }}";
                $(phoneId).val(userFoundData.phone);
            }
            if (userFoundData.zipcode){
                let zipcodeId = "#{{ form.homeAddress.zip.vars.id }}";
                $(zipcodeId).val(userFoundData.zipcode);
            }
            if (userFoundData.birthday){
                let dayId = "#{{ form.birthday.day.vars.id }}";
                let monthId = "#{{ form.birthday.month.vars.id }}";
                let yearId = "#{{ form.birthday.year.vars.id }}";
                let birthdayDate = new Date(userFoundData.birthday);

                $(dayId).val(birthdayDate.getDate());
                $(monthId).val(birthdayDate.getMonth());
                $(yearId).val(birthdayDate.getUTCFullYear());
            }
        });

        var rowUser;

        $('.getInfos').click(function(event){
            event.preventDefault();
            rowUser = $(this).parents('tr');
            $.get($(this).parents('tr').attr('href')).done(function(data){
                        showUserModal(data);
                    });
        })

        var showUserModal = function(data){
            $('#drawer').html(data);
            $('.userModal').modal();
            $('.toggle-orders').click(function(){
                $('section.orders').toggle();
            });
            $('#userForm').submit(function(e){
                e.preventDefault();
                $form = $(this);
                var values = {};
                $.each( $form.serializeArray(), function(i, field) {
                    values[field.name] = field.value;
                });

                $.post($form.attr( 'action' ),values)
                 .done(function(data){
                     table.row( rowUser ).data(data);
                    $('.userModal').modal('hide');
                    sweetAlert('', "Modifications prise en compte", 'success');
                 });
            })
        }

        var $pwdId = $("{{ '#' ~ form.plainPassword.vars.id }}");


        $('#buttonRegister').on('click', function(e){
            e.preventDefault();
           var x =  $pwdId.val();
           if (x && x.length < 6){
               sweetAlert('', "Veuillez entrer un mot de passe de plus de 6 charactères.", 'error');
               return;
           }
           $('#registerForm').submit();
        });

        $('.phone-user').keyup(function() {
            var
                val = $(this).val(),
                regex = /^(0|\+33)[1-9]([-. ]?[0-9]{2}){4}$/,
                url = "{{ path('clab_call_center_email_valid', {phone: 'PLACEHOLDER' }) }}"
            ;

            if (regex.test(val)) {
                $.get(url.replace('PLACEHOLDER', val), function(data) {
                    if (data.userExist) {
                        sweetAlert('', "Ce téléphone est déja utilisé", 'error');
                    }
                }).fail(function(){
                    alert('erreur serveur');
                });
            }
        });

        $('.email-user').keyup(function() {
            var
                    val = $(this).val(),
                    regex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,
                    url = "{{ path('clab_call_center_email_valid', {email: 'PLACEHOLDER' }) }}"
                    ;

            if (regex.test(val)) {
                $.get(url.replace('PLACEHOLDER', val), function(data) {
                    if (data.userExist) {
                        sweetAlert('', "Cet email est déja utilisé", 'error');
                    }
                }).fail(function(){
                    alert('erreur serveur');
                });
            }
        });


    </script>
{% endblock %}
