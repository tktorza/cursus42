{% extends 'ClabBoardBundle:Base:base.html.twig' %}

{% block bodyClass %}singlenav{% endblock %}

{% block body %}

    <div class="container padding-v-10" id="onboard">
        <div class="row">
            {% if cards is null %}
            <div class="col-md-6" id="saved-card" style="display: none">
                {% else %}
                <div class="col-md-6"  id="saved-card"  >
                    {% endif %}
                    {% if client is not null and cards is not null %}
                        <header class="panel-heading"><i class="fa fa-credit-card icon-left"></i>Mes moyens de paiement<br/>
                            <small>Pour payer avec une carte enregistrée, cliquez sur la carte avec laquelle vous
                                   souhaitez payer</small>
                        </header>
                        <div class="panel panel-default credit-card-box">
                            <div class="panel-body">
                                <table class="table ">
                                    <thead>
                                    <th>Type</th>
                                    <th>Date d'exp</th>
                                    <th>Numéro</th>
                                    <th>Nom</th>
                                    </thead>
                                    <tbody>
                                    {% for card in cards %}

                                        <tr id="{{ card.id }}">
                                            <td><a href="" style="color:#767676;">{{ card.brand }}</a></td>
                                            <td>{{ card.exp_month }}/{{ card.exp_year }}</td>
                                            <td>XXXX-XXXX-XXXX-{{ card.last4 }}</td>
                                            <td>
                                                {% if card.name is null %}
                                                    Non renseigné
                                                {% else %}
                                                    {{ card.name }}
                                                {% endif %}
                                            </td>
                                        </tr>

                                    {% endfor %}
                                    </tbody>
                                </table>
                                <a href="#" id="other" class="btn btn-info">Payer avec une autre carte</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
                {% if cards is not null %}
                <div class="col-md-6" id="new-card" style="display: none">
                    {% else %}
                    <div class="col-md-6" id="new-card">
                        {% endif %}
                        <div class="panel panel-default credit-card-box">
                            <header class="panel-heading"><i class="fa fa-credit-card icon-left"></i>Payer avec une
                                                                                                     nouvelle carte</header>
                            <div class="panel-body">
                                <div class="payment-errors"></div>
                                {{ form_start(form, {'attr': {'id': 'payment-form'}}) }}
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="form-group">
                                            <label for="cardNumber">Numéro de la carte</label>
                                            <div class="input-group">
                                                {{ form_widget(form.card, { 'attr': {'class': 'form-control',
                                                    'data-stripe':'number'} }) }}
                                                <span class="input-group-addon log"><i class="fa fa-credit-card"></i></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-7 col-md-7">
                                        <div class="form-inline">
                                            <div class="form-group">
                                                <label for="cardExpiry">Date d'expiration</label>
                                                {{  form_widget(form.month, { 'attr': {'class': 'form-control','data-stripe':'exp-month'} })  }}
                                                {{  form_widget(form.year, { 'attr': {'class': 'form-control',
                                                    'data-stripe':'exp-year'} })  }}

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-5 col-md-5 pull-right">
                                        <div class="form-group">
                                            <label for="cardCVC">Code de sécurité</label>
                                            {{  form_widget(form.cvc, { 'attr': {'class': 'form-control','data-stripe':'cvc'}})  }}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">
                                        <div class="form-group">
                                            <label for="couponCode">Nom (facultatif)</label>
                                            {{  form_widget(form.name, { 'attr': {'class': 'form-control',
                                                'data-stripe':'name'} })  }}
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-xs-12">

                                        {% if plan.amount == 0 %}
                                            <a href="{{ path('board_onboarding_pay_free_account',{contextPk:contextPk,
                                                slug:plan.id}) }}" class="btn btn-warning btn-block">Continuer sans carte
                                                                                                     bancaire</a>
                                            <br/>
                                            <button class="btn btn-success btn-block" type="submit">Enregistrer ma carte
                                            </button>

                                        {% else %}
                                            <button class="btn btn-success btn-block" type="submit">Payer</button>
                                            <br/>
                                        {% endif %}

                                        {% if cards is not null %}
                                            <a href="#" id="saved">Payer avec une carte enregistrée</a>
                                        {% endif %}
                                    </div>

                                </div>
                                {{ form_rest(form) }}
                                {{ form_end(form) }}
                            </div>
                        </div>

                    </div>


                    <div class="col-md-6">
                        <header class="panel-heading"><i class="fa fa-credit-card icon-left"></i>Récapitulatif</header>
                        <div class="well well2 text-center">
                            {% if plan.interval == 'month' %}
                                <h4>{{ plan.name }}</h4>
                                <br>
                                {% set planAmountMonth = ((plan.amount / 100))  %}
                                <p class="lead"><strong>{{ planAmountMonth|number_format(2, '.', ',') }}€
                                                                                                        / mois</strong></p>
                                <p>Soit {{ (planAmountMonth * 12)|number_format(2, '.', ',') }}€ HT / an</p>
                                {% if plan.id starts with 'clickeat-' %}
                                    <p>Commissions depuis :</p>
                                    <p><small>
                                            Clickeat <strong>9%</strong><br>
                                            Facebook <strong>{{ plan.id|last }}%</strong><br>
                                            Site internet <strong>{{ plan.id|last }}%</strong>
                                        </small></p>
                                {% endif %}
                            {% else %}
                                <h4>{{ plan.name }}</h4>
                                <br>
                                {% set planAmountYear = ((plan.amount / 100))  %}
                                <p class="lead"><strong>Soit un prélèvement unique de : {{ planAmountYear|number_format(2, '.', ',') }}€ HT / an</strong></p>
                                <p>Soit {{ (planAmountYear /12)|number_format(2, '.', ',') }}€ HT / mois</p>
                                {% if plan.id starts with 'clickeat-' %}
                                    <p>Commissions depuis :</p>
                                    <p><small>
                                            Clickeat <strong>9%</strong><br>
                                            Facebook <strong>{{ plan.id|last }}%</strong><br>
                                            Site internet <strong>{{ plan.id|last }}%</strong>
                                        </small></p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="https://js.stripe.com/v1/"></script>
    <script type="text/javascript" src="{{ asset('vendors/jquery-creditcardvalidator/jquery.creditCardValidator.js') }}"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            $('tr').click( function() {
                var getUrl = window.location;
                var baseUrl = getUrl .protocol + "//" + getUrl.host + "/" + getUrl.pathname.split('/')[1];

                var url = baseUrl + "/board/{{ restaurant.slug }}/onboard/customer/existing/{{ plan.id }}/"+ this.id;
                window.location.href = url;

            }).hover( function() {
                $(this).toggleClass('hover');
            });

            $('#other').click(function()
            {
                $('#saved-card').hide();
                $('#new-card').show();

            });
            $('#saved').click(function()
            {
                $('#saved-card').show();
                $('#new-card').hide();

            });

            $(function() {
                $('#clab_stripe_cardformtype_card').validateCreditCard(function(result) {
                    if(result.card_type == null)
                    {
                        $('.log').html('<i class="fa fa-credit-card"></i>');
                    }
                    else if(result.card_type.name == 'mastercard')
                    {
                        $('.log').html('<i class="fa fa-cc-mastercard"></i>');
                    }
                    else if(result.card_type.name == 'visa')
                    {
                        $('.log').html('<i class="fa fa-cc-visa"></i>');
                    }
                    else if(result.card_type.name == 'amex')
                    {
                        $('.log').html('<i class="fa fa-cc-amex"></i>');
                    }
                    else if(result.card_type.name == 'visa_electron')
                    {
                        $('.log').html('<i class="fa fa-cc-visa"></i>');
                    }
                    else if(result.card_type.name == 'maestro')
                    {
                        $('.log').html('<i class="fa fa-cc-visa"></i>');
                    }
                });
            });
            Stripe.setPublishableKey('{{ publishableKey }}');

            var stripeResponseHandler = function(status, response) {
                var $form = $('#payment-form');
                if (response.error) {
                    console.log(response.error);
                    if(response.error.param == 'exp_month')
                    {
                        $('.payment-errors').text('Votre date d\'expiration est invalide');
                    }
                    if(response.error.param == 'number')
                    {
                        $('.payment-errors').text('Votre numéro de carte est invalide');
                    }
                    if(response.error.param == 'cvc')
                    {
                        $('.payment-errors').text('Votre code de sécurité est invalide');
                    }

                    $form.find('button').prop('disabled', false);
                } else {
                    // token contains id, last4, and card type
                    var token = response.id;
                    // Insert the token into the form so it gets submitted to the server
                    $form.append($('<input type="hidden" name="stripeToken" />').val(token));
                    // and re-submit
                    $form.get(0).submit();
                }
            };
            jQuery(function($) {
                $('#payment-form').submit(function(e) {
                    var $form = $(this);
                    // Disable the submit button to prevent repeated clicks
                    $form.find('button').prop('disabled', true);
                    Stripe.card.createToken($form, stripeResponseHandler);
                    // Prevent the form from submitting with the default action
                    return false;
                });

            });
        });
    </script>
{% endblock %}
