{% extends 'ClabBoardBundle:Base:base.html.twig' %}

{% block subnav %}
    {% include 'ClabBoardBundle:Base:subnav.html.twig' with {
        category: 'store',
        route: 'board_restaurant_planning',
    } %}
{% endblock %}

{% block body %}
<div class="container-fluid form-bottom-padding" id="planning">
    <form method="post" action="{{ path('board_restaurant_planning', { contextPk: contextPk }) }}">
    <div class="row">
        <div class="col-md-9 padding-v-10 bg-white">

            <div class="input-list padding-v-10">

                <div class="row timesheet-day">
                    <div class="col-md-3">
                        <strong>Ajouter pour <br>tous les jours</strong>
                    </div>
                    <div class="col-md-7">
                        <div class="timesheet-list">
                            <div class="row timesheet-field">
                                <div class="col-md-4">
                                    <input type="time" class="form-control timepicker" id="allStart" name="" value="">
                                </div>
                                <div class="col-md-4">
                                    <input type="time" class="form-control timepicker" id="allEnd" name="" value="">
                                </div>
                                <div class="col-md-4">
                                    <small><a href="#" class="displayMaxPreorderTime"><i class="fa fa-eye icon-left"></i>Heure max de commande</a></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <a class="btn btn-success" id="addToAll">Ajouter</a>
                    </div>
                </div>
                <hr>
                {% for i in days %}
                    {% set checkbox = attribute(form, 'is_weekday_' ~ i) %}
                    {% set timesheetsForm = attribute(form, 'timesheets_' ~ i) %}
                    <div class="row timesheet-day">
                        <div class="col-md-3">
                            {{ form_row(checkbox, { attr: { class: 'icheck reveal', "data-target": 'timesheets-' ~ i } }) }}
                        </div>
                        <div class="col-md-7">
                            <div class="timesheet-list timesheets-{{ i }}" {% if timesheetsForm.vars.prototype is defined %}data-prototype="{{ _self.timesheet_prototype(timesheetsForm.vars.prototype)|e }}"{% endif %} {% if timesheetsForm|length == 0 %}style="display:none;"{% endif %}>
                                {% for timesheet in timesheetsForm %}
                                    <div class="row timesheet-field">
                                        <div class="col-md-4">
                                            {{ form_widget(timesheet.start, { attr: { class: 'form-control timepicker' }, label_render: false }) }}
                                            {{ form_errors(timesheet.start) }}
                                        </div>
                                        <div class="col-md-4">
                                            {{ form_widget(timesheet.end, { attr: { class: 'form-control timepicker' }, label_render: false }) }}
                                            {{ form_errors(timesheet.end) }}
                                        </div>
                                        <div class="col-md-3 maxPreorderTime">
                                            {{ form_widget(timesheet.maxPreorderTime, { attr: { class: 'form-control timepicker' }, label_render: false }) }}
                                            {{ form_errors(timesheet.maxPreorderTime) }}
                                        </div>
                                        <div class="col-md-1">
                                            <span class="remove"></span>
                                            {{ form_rest(timesheet) }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="timesheets-{{ i }}" {% if timesheetsForm|length == 0 %}style="display:none;"{% endif %}>
                                <div class="timesheet-add"></div>
                            </div>
                        </div>
                    </div>
                    {% if not loop.last %}
                    <hr>
                    {% endif %}
                {% endfor %}
            </div>
            <br><br>
        </div>

        <div class="col-md-3 padding-v-10">

            <p>Cochez les jours d’ouverture du restaurant et ajoutez-y les horaires de service.</p>

            <a class="btn btn-block btn-danger ladda-button" data-style="expand-right" data-target="ajaxModal" href="{{ path('board_restaurant_planning_close', { contextPk: contextPk }) }}">Programmer une fermeture</a>

            <br>

            <a class="btn btn-block btn-primary ladda-button" data-style="expand-right" data-target="ajaxModal" href="{{ path('board_restaurant_planning_change', { contextPk: contextPk }) }}">Modifier ponctuellement</a>

            <br>
            {% if form.upcomingEvent is defined %}
            <h3>Jour modifiés</h3>
            <div class="input-list padding-v-10">
                {% for eventForm in form.upcomingEvent %}
                <div class="row">
                    <div class="col-md-6">
                        {% set eventTimesheet = eventForm.vars.data %}
                        {% if eventTimesheet.startDate == eventTimesheet.endDate %}
                            <small>Le {{ eventTimesheet.startDate|date('d/m/Y') }}</small>
                        {% else %}
                            <small>Du {{ eventTimesheet.startDate|date('d/m/Y') }}<br> au {{ eventTimesheet.endDate|date('d/m/Y') }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <a class="btn btn-default confirmModal" data-route="{{ path('board_restaurant_planning_delete', { contextPk: contextPk, id: eventTimesheet.id }) }}"><i class="fa fa-trash-o"></i></a>
                    </div>
                </div>
                <br>
                <div class="row">
                    <div class="col-md-6">
                        {{ form_widget(eventForm.start, { attr: { class: 'form-control timepicker startPicker' }, label_render: false }) }}
                    </div>
                    <div class="col-md-6">
                         {{ form_widget(eventForm.end, { attr: { class: 'form-control timepicker endPicker' }, label_render: false }) }}
                        <span style="display:none;">
                            {{ form_row(eventForm.maxPreorderTime) }}
                        </span>
                    </div>
                </div>
                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}
            </div>
            {% endif %}

            {% if upcomingClose|length > 0 %}
            <br>
            <h3>Fermeture à venir</h3>
            <div class="input-list padding-v-10">
                {% for close in upcomingClose %}
                <div class="row">
                    <div class="col-md-3">
                        {% if close.startDate == close.endDate %}
                            <small>Le {{ close.startDate|date('d/m/Y') }}</small>
                        {% else %}
                            <small>Du {{ close.startDate|date('d/m/Y') }}<br> au {{ close.endDate|date('d/m/Y') }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-9">
                        <a class="btn btn-default confirmModal" data-route="{{ path('board_restaurant_planning_delete', { contextPk: contextPk, id: close.id }) }}"><i class="fa fa-trash-o"></i></a>
                    </div>
                </div>
                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <div class="hide">
                {{ form_rest(form) }}
            </div>
        </div>
    </div>
    {% include 'ClabBoardBundle:Base:formBottom.html.twig' with { cancelRoute: path('board_restaurant_planning', { contextPk: contextPk }) } %}
    </form>
</div>
{% endblock %}

{% block javascripts %}
<script type="text/javascript">
jQuery(document).ready(function() {

    $('.timesheet-add').each(function() {
        $(this).html('<a href="#" class="add_timesheet_link"><i class="fa fa-plus-circle fa-2x"></i></a>');
    });

    $('.timesheet-field').each(function() {
        addTimesheetFormDeleteLink($(this));
    });

    $('.add_timesheet_link').on('click', function(e) {
        e.preventDefault();
        addTimesheetForm($(this).parents('.timesheet-day').find('.timesheet-list'));
    });
});

function addTimesheetForm(collectionHolder) {
    var prototype = collectionHolder.attr('data-prototype');
    var newForm = prototype.replace(/__name__/g, $('.timesheet-field').length);

    var $newFormDiv = $('<div class="timesheet-field"></div>').append(newForm);
    collectionHolder.append($newFormDiv);

    addTimesheetFormDeleteLink($newFormDiv);

    initFields();
}

function addTimesheetFormDeleteLink($timesheetFormDiv) {
    var $removeFormA = $('<a href="#"><i class="fa fa-trash-o"></i></a>');
    $timesheetFormDiv.find('.remove').append($removeFormA);

    $removeFormA.on('click', function(e) {
        e.preventDefault();
        $timesheetFormDiv.remove();
    });

    displayMaxPreorderTime();
}

$(document).on('ifChecked', '.reveal', function(event) {
    element = $(document).find('.' + $(this).data('target'));
    element.show();
    if($(document).find('.' + $(this).data('target') + ' .timesheet-field').length == 0) {
        element.parents('.timesheet-day').find('.add_timesheet_link').click();
    }
});

$(document).on('ifUnchecked', '.reveal', function(event) {
    $(document).find('.' + $(this).data('target')).hide();
    $(document).find('.' + $(this).data('target') + ' .timesheet-field').each(function() {
        $(this).remove();
    })
});


$('#addToAll').on('click', function() {
    var start = $('#allStart').val();
    var end = $('#allEnd').val();

    if(start && end && start<end) {
        $('.reveal').each(function() {
            if($(this).prop('checked')) {
                element = $(document).find('.' + $(this).data('target'));
                element.parents('.timesheet-day').find('.add_timesheet_link').click();
            } else {
                $(this).iCheck('check');
            }
        });

        $('.timesheet-list').each(function() {
            var form = $(this).find('.timesheet-field').last();

            form.find('.startPicker').val(start);
            form.find('.endPicker').val(end);
        });
    }
    if(start>end){
        sweetAlert('Oops...', 'L\'heure de début doit être inférieure à l\'heure de fin', 'error');
    }

    $('#allStart').val('');
    $('#allEnd').val('');
});

var days = {'MONDAY':'Lundi','TUESDAY':'Mardi','WEDNESDAY':'Mercredi','THURSDAY':'Jeudi','FRIDAY':'Vendredi','SATURDAY':'Samedi','SUNDAY':'Dimanche'};

$('form button[type="submit"]').click(function(e){
    $('.timesheet-field').each(function(){
        var start = $(this).find('[class^="col-md"]:visible').eq(0).find('input').val(),
                end = $(this).find('[class^="col-md"]:visible').eq(1).find('input').val(),
                max = $(this).find('[class^="col-md"]:visible').eq(2).find('input').val(),
                day = $(this).parent().attr('day');
        console.log(start+" "+end+" "+max+" "+day);
        if(start && end){
            if(max && (max>end || max<start)){
                if(start>end){
                    e.preventDefault();
                    sweetAlert('Erreur le '+days[day], 'L\'heure de début doit être inférieure à l\'heure de fin \n L\'heure max de commande doit être comprise entre l\'heure de début et de fin', 'error');
                }
                else{
                    e.preventDefault();
                    sweetAlert('Erreur le '+days[day], 'L\'heure max de commande doit être comprise entre l\'heure de début et de fin', 'error');
                }
            }else{
                if(start>end){
                    e.preventDefault();
                    sweetAlert('Erreur le '+days[day], 'L\'heure de début doit être inférieure à l\'heure de fin', 'error');
                }
            }
        }
    })
})

var maxPreorderTime = false;
displayMaxPreorderTime();

$('.displayMaxPreorderTime').on('click', function(e) {
    e.preventDefault();
    maxPreorderTime = true;
    displayMaxPreorderTime();
});

function displayMaxPreorderTime()
{
    if(maxPreorderTime) {
        $('.maxPreorderTime').show();
    } else {
        $('.maxPreorderTime').hide();
    }
}
</script>
{% endblock %}

{% macro timesheet_prototype(timesheet) %}
    <div class="row">
        <div class="col-md-4">
            {{ form_widget(timesheet.start, { attr: { class: 'form-control timepicker startPicker' }, label_render: false }) }}
            {{ form_errors(timesheet.start) }}
        </div>
        <div class="col-md-4">
            {{ form_widget(timesheet.end, { attr: { class: 'form-control timepicker endPicker' }, label_render: false }) }}
            {{ form_errors(timesheet.end) }}
        </div>
        <div class="col-md-3 maxPreorderTime">
            {{ form_widget(timesheet.maxPreorderTime, { attr: { class: 'form-control timepicker' }, label_render: false }) }}
            {{ form_errors(timesheet.maxPreorderTime) }}
        </div>
        <div class="col-md-1">
            <span class="remove"></span>
            {{ form_rest(timesheet) }}
        </div>
    </div>
{% endmacro %}